#!/bin/bash

usage() {
cat << EOF
Usage: `basename $0` [options]

OPTIONS:
    -h, --help      Show this message.
    -f, --first-run Connects to the tivo and saves the show and tivo access info to the given files
    -s, --show-list File containing a list of shows titles to transcode.  default to '~/.tvt-shows'
    -t, --tivo      TiVo IP Address / host name.                          default to '~/.tvt-host'
    -m, --media-key Media Access Key                                      default to '~/.tvt-mak'
    -v, --verbose   Instructs the script to be verbose about what it's doing.
EOF
}

LONG_OPTIONS=0
FIRSTRUN=0
SHOWLIST=""
TIVO=""
MAK=""
VERBOSE=0

# Determine getopt support, and parse all the parameters we need.
getopt -T
if [[ $? -eq 4 ]]; then
	set -- $(getopt -o "hfs:t:m:v" -l "help,first-run,show-list:,tivo:,media-key:,verbose" -- "$@")
else
	set -- $(getopt hfs:t:m:v "$@")
fi

while [ $# -gt 0 ]; do
	case "$1" in
		-h | --help ) usage; exit 1;;
		-f | --first-run ) FIRSTRUN=1; shift ;;
		-s | --show-list ) SHOWLIST="$2"; shift 2;;
		-t | --tivo ) TIVO="$2"; shift 2;;
		-m | --media-key ) MAK="$2"; shift 2;;
		-v | --verbose ) VERBOSE=1; shift;;
		-- ) shift; break;;
		-* ) echo "Unrecognized option $1" 1>&2; exit 1;;
		* )  break;;
	esac
done

if [[ "$SHOWLIST" == "" ]]; then
	SHOWLIST=$(readlink -f ~/.tvt-shows)
elif [[ "$SHOWLIST" == "-" ]]; then
	SHOWLIST="/dev/stdin"
fi

if [[ "$TIVO" == "" ]]; then
	TIVO=`cat ~/.tvt-host`
else
	TIVO=`echo $TIVO | sed -s "s/^\(\(\"\(.*\)\"\)\|\('\(.*\)'\)\)\$/\\3\\5/g"`
fi

if [[ "$MAK" == "" ]]; then
	MAK=`cat ~/.tvt-mak`
else
	MAK=`echo $MAK | sed -s "s/^\(\(\"\(.*\)\"\)\|\('\(.*\)'\)\)\$/\\3\\5/g"`
fi

PROCESSEDLIST=`readlink -f ~/.tvt-processed-shows`

if [[ "$VERBOSE" == "1" ]]; then
	echo "Showlist:  $SHOWLIST"
	echo "Processed: $PROCESSEDLIST"
	echo "Tivo:      $TIVO"
	echo "Mak:       $MAK"
	echo "Verbose:   $VERBOSE"
	echo "Firstrun:  $FIRSTRUN"
fi


if [[ "$FIRSTRUN" == "1" ]]; then
	# make sure the showlist isn't /dev/stdin
	if [[ "$SHOWLIST" == "/dev/stdin" ]]; then
		echo "You cannot save firstrun data to /dev/stdin. Please specify a show list file."
		usage
		exit 1
	fi

	# We need these options
	if [[ -z $TIVO ]] || [[ -z $MAK ]]; then
		usage
		exit 1
	fi
fi

# TODO: Make sure HandbrakeCli and tivodecode are on the command line.

# getShowList(outputfilename)
# Parses the global NOWPLAYING list and writes all the show titles (individual and folders)
# Which are not special 'HD' or 'TiVo Suggestions' to tthe given file. You can 
# use this to get a list of all the shows on the tivo, and then only select the 
# ones you want to process each run.
function getShowList {
	local output="$1"

	# Get the list of folders from the NOWPLAYING output, parsing out the URLs to get the episode lists.
	echo $NOWPLAYING | xsltproc lib/listfolders.xsl - | sed 's/|.*//g' > $output

	# Get the list of individual shows from the NOWPLAYING, append to output.
	echo $NOWPLAYING | xsltproc lib/listshows.xsl - >> $output
}

# Construct the global SUBSCRIBED array, and a function to load it.
SUBSCRIBED=()
function loadSubscribed {
	while read TITLE; do
		SUBSCRIBED+=("${TITLE}")
	done < $SHOWLIST
}

# Construct the global LOCKNAME, and a function to get it, or kill the process.
LOCKNAME="encode_$TIVO.lock"
function lockOrDie {
	lockfile -10 -r 3 $LOCKNAME
	if [[ "$?" != "0" ]]; then
		echo "Could not obtain lock to process shows for TiVo $TIVO. Perhaps another process is still running?"
		exit 1
	fi
}

# Removes the lock file.
function cleanupLock {
	rm -f $LOCKNAME
}

# isProcessed(showname, programid)
# returns 0 if the show has never been processed, false otherwise.
function isNotProcessed {
	PROCESSED=`fgrep "$1:$2" $PROCESSEDLIST`
	# return values in bash are so silly.
	if [[ "$PROCESSED" == "" ]]; then
		return 0
	else
		return 1
	fi
}

# processShow(nowplayingxml, showname)
# Parses the provided nowplaying xml (can be global or show-specific) for programids matching the given show name
# Downloads & decodes the mpeg streams from the tivo.
function processShow {
	local PROGRAMIDS
	PROGRAMIDS=`echo $1 | xsltproc --stringparam ShowTitle "$2" lib/programid.xsl - `
	for PROGRAMID in $PROGRAMIDS; do
		if isNotProcessed $2 $PROGRAMID; then
			echo "Processing $2:$PROGRAMID" 1>&2

			# Parse the URL from the now playing.
			local MPEGURL
			MPEGURL=`echo $1 | xsltproc --stringparam ProgramId "$PROGRAMID" lib/mpegurl.xsl -`

			local TARGETFILENAME
			TARGETFILENAME=`echo $1 | xsltproc --stringparam ProgramId "$PROGRAMID" lib/targetfilename.xsl -`
			
			# Paranoia, if we end up with an empty file name, default to the program id as a last resort.
			if [[ "$TARGETFILENAME" == "" ]]; then
				TARGETFILENAME="$PROGRAMID"
			fi
			
			# Prefix the directory.
			TARGETFILENAME="$2/$TARGETFILENAME.m4v"

			echo "  Craeting output diretory..."
			mkdir -p "$2"

			echo "  Downloading & Decoding from $MPEGURL"
			if [[ ! -f $PROGRAMID.tivo ]]; then
				curl --cookie sid=abc -s --digest -k -u tivo:$MAK -c cookies.txt "$MPEGURL" | tivodecode -m $MAK -o $PROGRAMID.tivo -
			fi

			echo "  Transcoding... to $TARGETFILENAME"
			if [[ -f $PROGRAMID.tivo ]] && [[ ! -f $TARGETFILENAME ]]; then
				HandBrakeCLI -i $PROGRAMID.tivo -o "$TARGETFILENAME" -f mp4 -O -e x264 --x264-profile high -b 1100 --two-pass -r 29.97 -a 1 -E faac -B 160 -6 stereo -R Auto --gain 5.0 --detelecine --decomb --strict-anamorphic
				echo "$2:$PROGRAMID" >> $PROCESSEDLIST
			else 
				echo "    Skipping transcode. I'm either missing $PROGRAMID.tivo, or $TARGETFILENAME already exists."
			fi
			rm $PROGRAMID.tivo
		else
			echo "Skipping $2:$PROGRAMID. This episode has already been processed. Please remove it from your TiVo." 1>&2
		fi
	done

	if [[ "$PROGRAMIDS" == " " ]]; then
		# Found nothing
		return 0
	else
		# Found something
		return 1
	fi
}

# Function which loads the subscriptions into the global array, then takes action
# on each show in the array, looking for episodes on the TiVo to process.
function processSubscriptions {
	loadSubscribed
	
	# For every showname we're subscribed to, look for a ProgramID with that show title from the global Now Playing list.
	for SHOW in "${SUBSCRIBED[@]}"; do
		# processShow returns true if we didn't find anything.
		if processShow "$NOWPLAYING" "$SHOW"; then
			local TITLEPLAYINGURL
			TITLEPLAYINGURL=`echo $NOWPLAYING | xsltproc lib/listfolders.xsl - | grep "$SHOW" | sed 's/.*|//g'`
			echo "Getting the Now Playing list for episodes of $SHOW from $TITLEPLAYINGURL"

			local TITLEPLAYING
			TITLEPLAYING="`curl -s --digest -k -u tivo:$MAK "$TITLEPLAYINGURL"`"

			if processShow "$TITLEPLAYING" "$SHOW"; then
				echo "Did not find any pending episodes on the TiVo for $SHOW"
			fi
		fi
	done
}

# Get a global NowPlaying list (of individual shows and folders)
# We recurse into folders manually when we need to, so that we can get the full
# listing of -all- the shows (and episodes if necessary)
echo "Connecting as tivo@$TIVO to download Now Playing list...."
NOWPLAYING="`curl -s --digest -k -u tivo:$MAK "https://$TIVO/TiVoConnect?Command=QueryContainer&Container=%2FNowPlaying"`"

# If this is a first run, we are going to save data.
if [[ "$FIRSTRUN" == "1" ]]; then
	echo "$TIVO" > ~/.tvt-host
	echo "$MAK" > ~/.tvt-mak
	getShowList $SHOWLIST
else
	if [[ ! -f $SHOWLIST ]]; then
		echo "Could not read from specified show list file: $SHOWLIST" 1>&2
		exit 1
	fi

	# Make sure we have a file to keep a list of all the things we've already processed.
	touch $PROCESSEDLIST

	lockOrDie
	processSubscriptions
	cleanupLock
fi

